<?php 

define('SHANTI_ESSAYS_PATH',drupal_get_path('module','shanti_essays'));

function shanti_essays_menu() {
  return array(
    'shanti_essays/test' => array(
      'title' => 'SHANTI Essays Test Page',
      'page callback' => 'shanti_essays_test',
      'type' => MENU_NORMAL_ITEM,
      'access arguments' => array('access content'), 
    ),
    'shanti_essays/json/%' => array(
      'page callback' => 'shanti_essays_json',
      'page arguments' => array(2),
      'type' => MENU_CALLBACK,
      'access arguments' => array('access content'),
    ),
    'shanti_essays/whole/%' => array(
      'page callback' => 'shanti_essays_whole',
      'page arguments' => array(2),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    ),
    'node/%node/book_toc' => array(
      'title' => 'Contents',
      'page callback' => 'shanti_essays_show_toc',
      'page arguments' => array(1),
      'type' => MENU_LOCAL_TASK,
      'access arguments' => array('access content'),
      'weight' => 2,
    )

  );
}

function shanti_essays_show_toc($node) {
  $output = shanti_essays_get_toc($node);
  dpm($output);
  return drupal_render($output);
}

function shanti_essays_get_toc($node) {
  $output = array();
  if ($node->type == 'book') {
    $bid = $node->book['bid'];
    $toc = book_toc($bid, 7);
    $tree = menu_tree_all_data(book_menu_name($bid));
    $output = menu_tree_output($tree);
  } 
  return $output;  
}

function shanti_essays_test() {
  return "Test.";
}

function shanti_essays_whole($nid) {
  if (user_access('access content')) {
    $node = node_load($nid);
    if (isset($node->book)) {
      $tree = book_menu_subtree_data($node->book);  
      $contents = book_export_traverse($tree, '_shanti_essays_whole_node');
      return theme('shanti_essays_whole_html', 
        array(
          'title' => $node->title, 
          'contents' => $contents, 
          'depth' => $node->book['depth']
        )
      );
    }
    else {
      drupal_not_found();
    }
  }
  else {
    drupal_access_denied();
  }
  
}

function _shanti_essays_whole_node($node, $children = '') {
    $build = node_view($node, 'print');
    unset($build['#theme']);
    // @todo Rendering should happen in the template using render().
    $node->rendered = drupal_render($build);
    return theme('shanti_essays_whole_node_html', array('node' => $node, 'children' => $children)
     );
}

function template_preprocess_shanti_essays_whole_html (&$vars) {
  global $base_url, $language;
  $vars['title'] = check_plain($vars['title']);
  $vars['base_url'] = $base_url;
  $vars['language'] = $language;
  $vars['language_rtl'] = ($language->direction == LANGUAGE_RTL);
  $vars['head'] = drupal_get_html_head();
  $vars['dir'] = $language->direction ? 'rtl' : 'ltr';  
}

function template_preprocess_shanti_essays_whole_node_html (&$vars) {
  $vars['depth'] = $vars['node']->book['depth'];
  $vars['title'] = check_plain($vars['node']->title);
  $vars['content'] = $vars['node']->rendered;
}

function shanti_essays_json($bid) {
  $toc = book_toc($bid,7);
  return '';
}

function shanti_essays_help($path, $arg) {
  if ($path == "admin/help#shanti_essays") {
    return '<p>' . t('SHANTI Essays, my friend.') . '</p>';
  }
}

function shanti_essays_filter_info() {
  $filters = array();
  $filters['shanti_essays_pullquote'] = array(
    'title'             => t('Pull Quotes'),
    'description'       => t('Makes a copy of the selection and puts it into a pull quote.'),
    'process callback'  => '_shanti_essays_pullquote_filter_process',
    'tips callback'     => '_shanti_essays_pullquote_filter_tips',
  );
  return $filters;
}

function _shanti_essays_pullquote_filter_process($text, $filter, $format) {
  $text = preg_replace("/\[pqr\](.*)\[\/pqr\]/m","$1<span class='shanti-essays-pullquote-right'>$1</span>",$text);
  $text = preg_replace("/\[pql\](.*)\[\/pql\]/m","$1<span class='shanti-essays-pullquote-left'>$1</span>",$text);
  $text_lines = explode("<",$text);
  for ($i = 0; $i < count($text_lines); $i++) {
    if (preg_match("/^h([1-7])/",$text_lines[$i],$matches)) {
      $text_lines[$i] = "<a id='h1_{$i}'></a><".$text_lines[$i]; 
    } elseif ($i > 0) {
      $text_lines[$i] = "<".$text_lines[$i];
    }
  }
  $text = implode('',$text_lines);
  return $text;
}

function _shanti_essays_pullquote_filter_tips($filter, $format, $long = FALSE) {
  $text = '<em>[pqr]...[/pqr]</em> produces a right-side pull quote from the text. ';
  $text .= '<em>[pql]...[/pql]</em> produces a left-side pull quote from the text. ';
  return t($text);
}

// This may need to change to use hook_theme_registry_alter instead
// (which is only executed when the theme cache is re-built)
function shanti_essays_theme($existing, $type, $theme, $path) {
  return array(
    'node__book' => array(
      'render element' => 'node',
      'template' => 'templates/node--book',
      'path' => SHANTI_ESSAYS_PATH,
    ),
    'book_navigation' => array(
      'render element' => 'book',
      'template' => 'templates/book-navigation',
      'path' => SHANTI_ESSAYS_PATH,
    ),
 
    'page__node__book' => array(
      'render element' => 'page',
      'template' => 'templates/page--node',
      'path' => SHANTI_ESSAYS_PATH,
    ),
    
    'shanti_essays_whole_html' => array(
      'variables' => array('title' => NULL, 'contents' => NULL, 'depth' => NULL),
      'template' => 'templates/shanti-essays-whole-html',
      'path' => SHANTI_ESSAYS_PATH,
    ),

    'shanti_essays_whole_node_html' => array(
      'variables' => array('node' => NULL, 'children' => NULL),
      'template' => 'templates/shanti-essays-whole-node-html',
      'path' => SHANTI_ESSAYS_PATH,
    ),
    
  );
}

/*

function shanti_essays_menu_alter(&$items) {}

function shanti_essays_page_alter(&$page) {}

function shanti_essays_page_node_view_alter(&$build) {}



*/

function shanti_essays_preprocess_html(&$vars) {}

function shanti_essays_preprocess_page(&$vars) {}

function shanti_essays_preprocess_node(&$vars) {
  
  if ($vars['type'] == 'book') {
        
    $nid      = $vars['nid'];
    $bid      = $vars['book']['bid'];
    $top_mlid = $vars['book']['p1'];
            
    if (user_access('add content to books')) {
      // Fix BMS link
      if(isset($vars['content']['links'][0]['#links']['book_made_simple_book'])) {
        $vars['content']['links']['book']['#links']['book_made_simple_book'] = $vars['content']['links'][0]['#links']['book_made_simple_book'];
        $vars['content']['links']['book']['#links']['book_made_simple_book']['title'] = 'Add Essay page below this page';
        unset($vars['content']['links'][0]);      
      }
      // Add another link to add a page to the top          
      $vars['content']['links']['book']['#links']['shanti_essays_add_page_top'] = array(
        'title'       => 'Add Essay page below top page',
        'href'        => 'node/add/book',
        'query'       => array('parent' => $top_mlid),
        'attributes'  => array('title' => 'Add Essay page below <em>top</em> page')
      );
      // And modify the existing one
      if ($bid == $nid) {
        unset($vars['content']['links']['book']['#links']['book_made_simple_book']);
        $vars['content']['links']['book']['#links']['shanti_essays_add_page_top']['title'] = "Add Essay page";
      }
    }    
    
    // What the hell is all this for?
    $book_node = node_load($bid);   
    $book_menu_name = book_menu_name($bid);
    $book_links = menu_load_links($book_menu_name);
    $vars['shanti_essays']['top_mlid']   = $top_mlid;
    $vars['shanti_essays']['book_title'] = $book_node->title;
    $vars['shanti_essays']['book_url']   = drupal_get_path_alias('/node/' . $bid);
    
    // Add CSS and JS
    drupal_add_css(SHANTI_ESSAYS_PATH . '/css/shanti_essays.css');
    $js_settings = array(
      'book' => $vars['book'],
      'book_title' => $vars['shanti_essays']['book_title'],
    );
    drupal_add_js(array('shantiEssays' => $js_settings), 'setting');
    drupal_add_js(SHANTI_ESSAYS_PATH . '/js/shanti_essays.js', 'file');
       
  }
}

function shanti_essays_preprocess_book_navigation(&$vars) {
  //kpr($vars); 
} 

function shanti_essays_enable() {
  drupal_set_message($message = t('SHANTI Essays activated.'), $type = 'status');
  drupal_theme_rebuild();
}

